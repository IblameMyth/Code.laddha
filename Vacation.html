<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vacation</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f8fafc;
      --card:rgba(255, 255, 255, 0.9);
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --accent:#0ea5a4;
      --radius:12px;
      --shadow:0 8px 26px rgba(15,23,42,0.06);
      --container:1100px;
      --bg-img:url('https://images.unsplash.com/photo-1542223616-1e7b2d2b02d9?auto=format&fit=crop&w=1500&q=80');
      --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;padding:28px;font-family:Inter,'Segoe UI',Roboto;background-image:linear-gradient(rgba(255,255,255,0.86),rgba(255,255,255,0.86)),var(--bg-img);background-size:cover;background-position:center;color:var(--text)}
    main{
      max-width:var(--container);
      margin:0 auto;
      min-height:68vh;
      padding:28px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
    }
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
    header{display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent),var(--primary));color:#fff;padding:16px 20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px}
    header h1{margin:0;font-size:1.6rem;font-family:'Poppins',sans-serif;font-weight:600;letter-spacing:0.5px}
    input[type="number"]{padding:10px;border-radius:10px;border:1px solid #e6eef8;background:#fff;min-width:150px;margin:8px}
    button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;cursor:pointer}
    canvas{display:block;margin:18px auto;max-width:640px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06);padding:8px}
    #summary{margin-top:12px;font-weight:700}
    footer{margin-top:36px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>ExpenseWise</h1>
  </header>

  <main>
    <h2>Vacation Expenses</h2>
    <div style="margin-bottom: 20px;">
      <label for="expenseMonth">Select Month: </label>
      <input type="month" id="expenseMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
    </div>
    <input type="number" id="tickets" placeholder="Tickets (₹)" />
    <input type="number" id="hostel" placeholder="Hostel (₹)" />
    <input type="number" id="food" placeholder="Food (₹)" />
    <input type="number" id="traveling" placeholder="Traveling (₹)" />
    <br />
    <button onclick="showVacationChart()">Show Chart</button>
    <button onclick="clearAllData()" style="background: linear-gradient(90deg, #dc2626, #ef4444); margin-left: 10px;">Clear All Data</button>
    <div id="summary"></div>
    <canvas id="vacChart"></canvas>

    <div class="table-container" style="margin-top: 20px;">
      <table class="expense-table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Tickets</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Hostel</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Food</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Traveling</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
        <tfoot>
          <tr>
            <td style="padding: 12px; font-weight: bold;">Total</td>
            <td id="totalTickets" style="padding: 12px;">₹0</td>
            <td id="totalHostel" style="padding: 12px;">₹0</td>
            <td id="totalFood" style="padding: 12px;">₹0</td>
            <td id="totalTraveling" style="padding: 12px;">₹0</td>
            <td id="grandTotal" style="padding: 12px; font-weight: bold;">₹0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </main>

  <footer>
    Travel is the only thing you buy that makes you richer.
  </footer>

  <script>
    // Set current month as default
    window.addEventListener('load', function() {
      const today = new Date();
      const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      document.getElementById('expenseMonth').value = month;

      // Load saved data from XML and populate localStorage
      fetch('expenses.xml')
        .then(response => response.text())
        .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
        .then(xml => {
          // Find the current month's node
          const monthNode = Array.from(xml.getElementsByTagName('month')).find(m => 
            m.getAttribute('id') === month
          );
          
          if (monthNode) {
            const vacationNode = monthNode.getElementsByTagName('vacation')[0];
            if (vacationNode) {
              const data = {
                tickets: Number(vacationNode.getElementsByTagName('tickets')[0]?.textContent || 0),
                hostel: Number(vacationNode.getElementsByTagName('hostel')[0]?.textContent || 0),
                food: Number(vacationNode.getElementsByTagName('food')[0]?.textContent || 0),
                traveling: Number(vacationNode.getElementsByTagName('traveling')[0]?.textContent || 0)
              };

              // Save to localStorage
              localStorage.setItem('vacationExpenses_' + month, JSON.stringify(data));
            }
          }
          
          // Now load the data from localStorage
          loadMonthlyData(month);
        })
        .catch(error => {
          console.error('Error loading expenses:', error);
          loadMonthlyData(month);
        });
    });

    // Load data for selected month
    document.getElementById('expenseMonth').addEventListener('change', function() {
      loadMonthlyData(this.value);
    });

    function updateTable() {
      const tableBody = document.getElementById('expenseTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '';

      const expenses = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('vacationExpenses_')) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            if (data && data.date && data.date.startsWith(document.getElementById('expenseMonth').value)) {
              expenses.push(data);
            }
          } catch (e) { /* ignore malformed */ }
        }
      }

      expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

      let totalTickets = 0, totalHostel = 0, totalFood = 0, totalTraveling = 0;

      expenses.forEach(expense => {
        const row = document.createElement('tr');
        const total = (expense.tickets || 0) + (expense.hostel || 0) + 
                     (expense.food || 0) + (expense.traveling || 0);
        row.innerHTML = `
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8; cursor: pointer;" onclick="loadExpense('${expense.date}')">
            ${expense.date}
          </td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹${expense.tickets || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹${expense.hostel || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹${expense.food || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹${expense.traveling || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹${total}</td>
        `;

        tableBody.appendChild(row);

        totalTickets += expense.tickets || 0;
        totalHostel += expense.hostel || 0;
        totalFood += expense.food || 0;
        totalTraveling += expense.traveling || 0;
      });

      document.getElementById('totalTickets').textContent = `₹${totalTickets}`;
      document.getElementById('totalHostel').textContent = `₹${totalHostel}`;
      document.getElementById('totalFood').textContent = `₹${totalFood}`;
      document.getElementById('totalTraveling').textContent = `₹${totalTraveling}`;
      document.getElementById('grandTotal').textContent = 
        `₹${totalTickets + totalHostel + totalFood + totalTraveling}`;
    }

    function loadMonthlyData(monthKey) {
      // First try localStorage for immediate data
      const savedData = localStorage.getItem('vacationExpenses_' + monthKey);
      if (savedData) {
        const data = JSON.parse(savedData);
        document.getElementById('tickets').value = data.tickets || '';
        document.getElementById('hostel').value = data.hostel || '';
        document.getElementById('food').value = data.food || '';
        document.getElementById('traveling').value = data.traveling || '';
        showVacationChart(); // Show chart with saved data
      } else {
        // If not in localStorage, try loading from XML
        fetch('expenses.xml')
          .then(response => response.text())
          .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
          .then(xml => {
            const monthNode = Array.from(xml.getElementsByTagName('month')).find(m => 
              m.getAttribute('id') === monthKey
            );
            
            if (monthNode) {
              const vacationNode = monthNode.getElementsByTagName('vacation')[0];
              if (vacationNode) {
                const data = {
                  tickets: Number(vacationNode.getElementsByTagName('tickets')[0]?.textContent || 0),
                  hostel: Number(vacationNode.getElementsByTagName('hostel')[0]?.textContent || 0),
                  food: Number(vacationNode.getElementsByTagName('food')[0]?.textContent || 0),
                  traveling: Number(vacationNode.getElementsByTagName('traveling')[0]?.textContent || 0)
                };

                // Update the form
                document.getElementById('tickets').value = data.tickets || '';
                document.getElementById('hostel').value = data.hostel || '';
                document.getElementById('food').value = data.food || '';
                document.getElementById('traveling').value = data.traveling || '';

                // Save to localStorage for future use
                localStorage.setItem('vacationExpenses_' + monthKey, JSON.stringify(data));
                showVacationChart();
                return;
              }
            }
            
            // If no data found, clear the form
            clearForm();
          })
          .catch(error => {
            console.error('Error loading expenses:', error);
            clearForm();
          });
      }
      updateTable();
    }

    function clearForm() {
      document.getElementById('tickets').value = '';
      document.getElementById('hostel').value = '';
      document.getElementById('food').value = '';
      document.getElementById('traveling').value = '';
      document.getElementById('summary').innerHTML = '';
      if (window.vacationChart) {
        window.vacationChart.destroy();
      }
    }

    function loadExpense(date) {
      document.getElementById('expenseMonth').value = date.substring(0, 7);
      const data = JSON.parse(localStorage.getItem(`vacationExpenses_${date}`));
      if (data) {
        document.getElementById('tickets').value = data.tickets || '';
        document.getElementById('hostel').value = data.hostel || '';
        document.getElementById('food').value = data.food || '';
        document.getElementById('traveling').value = data.traveling || '';
        showVacationChart();
      }
    }

    function showVacationChart() {
      const tickets = parseInt(document.getElementById('tickets').value) || 0;
      const hostel = parseInt(document.getElementById('hostel').value) || 0;
      const food = parseInt(document.getElementById('food').value) || 0;
      const traveling = parseInt(document.getElementById('traveling').value) || 0;
      const total = tickets + hostel + food + traveling;

      // Get the full date (YYYY-MM-DD)
      const monthKey = document.getElementById('expenseMonth').value;
      const today = new Date();
      const date = `${monthKey}-${String(today.getDate()).padStart(2, '0')}`;
      
      // Save data to localStorage and XML
      const expenseData = {
        date: date,
        tickets: tickets, 
        hostel: hostel, 
        food: food, 
        traveling: traveling
      };

      // Save to localStorage for immediate use
      localStorage.setItem('vacationExpenses_' + date, JSON.stringify(expenseData));

      // Save to XML via PHP
      fetch('save_expense.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type: 'vacation',
          date: date,
          tickets: tickets,
          hostel: hostel,
          food: food,
          traveling: traveling
        })
      })
      .catch(error => console.error('Error saving expense:', error));

      // Update table and summary
      updateTable();
      document.getElementById('summary').innerHTML = `<h3>Total Vacation Expenses: ₹${total}</h3>`;

      const ctx = document.getElementById('vacChart').getContext('2d');
      if (window.vacationChart) {
        window.vacationChart.destroy();
      }

      window.vacationChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Tickets', 'Hostel', 'Food', 'Traveling'],
          datasets: [{
            data: [tickets, hostel, food, traveling],
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${percentage}% (₹${value})`;
                }
              }
            },
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Initialize table on load
    updateTable();

    // Clear all vacation expense data
    function clearAllData() {
      if (confirm('Are you sure you want to clear all vacation expense data? This cannot be undone.')) {
        // Get all keys from localStorage
        const keys = Object.keys(localStorage);
        
        // Remove only vacation-related data
        let deletedCount = 0;
        keys.forEach(key => {
          if (key.startsWith('vacationExpenses_')) {
            localStorage.removeItem(key);
            deletedCount++;
          }
        });
        
        // Clear form fields
        clearForm();
        
        // Update table
        updateTable();
        
        alert(`Successfully cleared ${deletedCount} vacation expense records.`);
      }
    }
  </script>
</body>
</html>
